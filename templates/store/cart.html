{% extends 'base.html' %}

{% load static %}

{% block content %}

<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="index.html" rel="nofollow">Home</a>
                <span></span> Shop
                <span></span> Your Cart
            </div>
        </div>
    </div>
    <section class="mt-50 mb-50">
        <div class="container">
            {% if not cart_items %}
            <h2 class="text-center">Your Cart is Empty</h2>
            <br>
            <div class="text-center">
                <a href="{% url 'store' %}" class="btn btn-primary">Continue Shopping</a>

            </div>
            {% else %}
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table shopping-summery text-center clean">
                            <thead>
                                <tr class="main-heading">
                                    <th scope="col">Image</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Price</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Subtotal</th>
                                    <th scope="col">Remove</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cart_item in cart_items %}
                                    <tr data-product-id="{{ cart_item.product.id }}">
                                        <td class="image product-thumbnail"><img src="{{ cart_item.product.images.url }}" alt="#"></td>
                                        <td class="product-des product-name">
                                            <h5 class="product-name"><a href="{{ cart_item.product.get_url }}">{{ cart_item.product.product_name }}</a></h5>
                                            <p class="font-xs">{{ cart_item.product.catagory }}</p>
                                        </td>
                                        <td class="price" data-title="Price"><span class="product-price">₹{{ cart_item.product.price }}</span></td>

                                        {% comment %} <td class="price" data-title="Price"><span>₹{{ cart_item.product.price }} </span></td> {% endcomment %}
                                        <td class="text-center" data-title="Stock">
                                                <div class="detail-qty border radius  m-auto">
                                                    <a href="#" class="qty-down"><i class="fi-rs-angle-small-down"></i></a>
                                                    <span class="qty-val" id="quantity-{{ cart_item.product.id }}">{{ cart_item.quantity }}</span>
                                                    <a href="#" class="qty-up"><i class="fi-rs-angle-small-up"></i></a>
                                                </div>
                                        </td>
                                        <td class="text-right" data-title="Cart">
                                            <span class="sub_total_price">₹{{ cart_item.sub_total }}</span>
                                        </td>
                                        <td class="action" data-title="Remove">
                                            <a href="{% url 'remove_cart_item' cart_item.product.id %}" class="text-muted"><i class="fi-rs-trash"></i></a>
                                        </td>
                                    </tr>
                                {% endfor %}

                                
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="cart-action text-end">
                        {% comment %} <a class="btn  mr-10 mb-sm-15"><i class="fi-rs-shuffle mr-10"></i>Update Cart</a> {% endcomment %}
                        <a class="btn " href="{% url 'store' %}"><i class="fi-rs-shopping-bag mr-10"></i>Continue Shopping</a>
                    </div>
                    <div class="divider center_icon mt-50 mb-50"><i class="fi-rs-fingerprint"></i></div>
                    <div class="row mb-50">
                        <div class="col-lg-6 col-md-12">
                            {% if user.is_authenticated %}
                            <div class="mb-30 mt-50">
                                <div class="heading_s1 mb-3">
                                    <h4>Apply Coupon</h4>
                                </div>
                                <div class="total-amount">
                                    <div class="left">
                                        <div class="coupon">
                                            <form action="#" target="_blank" method = "POST" id='coupon-form'>
                                                {% csrf_token %}
                                                <div class="form-row row justify-content-center align-items-center">
                                                    {% comment %} {{ coupon_form }} {% endcomment %}
                                                    <input class="font-medium" name="Coupon" placeholder="Enter Your Coupon">
                                                    
                                                    <div class="form-group col-lg-12 d-flex justify-content-end pt-3">
                                                        <button type="submit" class="btn  btn-md"><i class="fi-rs-label mr-10"></i>Apply</button>
                                                        <input type="hidden" name="coupon_id" value="{{ coupon_id }}">

                                                    </div>
                                                </div>
                                            </form>
                                            <h5 id='resp'></h5>
                                            {% comment %} {% if coupon_error %}
                                                <p class="text-danger">{{ coupon_error }}</p>
                                            {% endif %}
                                            {% if applied_coupon %}
                                                <p class="text-success">Coupon applied: {{ applied_coupon.code }}</p>
                                            {% endif %} {% endcomment %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-lg-6 col-md-12">
                            <div class="border p-md-4 p-30 border-radius cart-totals">
                                <div class="heading_s1 mb-3">
                                    <h4>Cart Totals</h4>
                                </div>
                                <div class="table-responsive">
                                    <table class="table">
                                        <tbody>
                                            <tr>
                                                <td class="cart_total_label">Cart Subtotal</td>
                                                <td class="cart_total_amount"><span class="font-lg fw-900 text-brand" id ='cart-subtotal'>₹{{ total }}</span></td>
                                            </tr>
                                            <tr>
                                                <td class="cart_total_label">GST</td>
                                                <td class="cart_total_amount"> <i class="ti-gift mr-5" id="gst-amount"></i>₹{{ GST }}</td>
                                            </tr>
                                            <tr id='coupon-row' style="display:none;">
                                              <td class="cart_total_label">Coupon Discount</td>
                                              <td class="cart_total_amount font-lg fw-500 text-brand" id="discount-amount"></td>
                                            </tr>
                                            <tr>
                                                <td class="cart_total_label">Grand Total</td>
                                                <td class="cart_total_amount"><strong><span class="font-xl fw-900 text-brand" id='total_amnt'>₹{{ grand_total }}</span></strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <a href="{% url 'checkout' %}" class="btn " id='proceed-chekout'> <i class="fi-rs-box-alt mr-10" ></i> Proceed To CheckOut</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </section>
</main>

{% endblock content %} 

{% block script %}

<!-- Include jQuery library -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
      // Get the CSRF token
      var csrftoken = getCookie('csrftoken');
  
      // Include the CSRF token in AJAX headers
      $.ajaxSetup({
        beforeSend: function(xhr, settings) {
          if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
            // Only send the token to relative URLs i.e. locally.
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
          }
        }
      });
  
      $(".qty-up").click(function(e) {
        e.preventDefault();
        var quantityElement = $(this).siblings(".qty-val");
        var quantity = parseInt(quantityElement.text());
        var newQuantity = quantity + 1;
        var productId = $(this).closest("tr").data("product-id");
  
        // Send AJAX request to update the quantity
        $.ajax({
          url: "/cart/update_cart/" + productId + "/",
          method: "POST",
          data: { quantity: newQuantity },
          success: function(response) {
            quantityElement.text(newQuantity);
            updatePriceAndTotal(response);
          },
          error: function(xhr, status, error) {
            //console.log(xhr.responseText);
          }
        });
      });
  
      $(".qty-down").click(function(e) {
        e.preventDefault();
        var quantityElement = $(this).siblings(".qty-val");
        var quantity = parseInt(quantityElement.text());
        var newQuantity = quantity - 1;
        var productId = $(this).closest("tr").data("product-id");
        //console.log(quantityElement)
  
        if (newQuantity < 1) {
          return;
        }
  
        // Send AJAX request to update the quantity
        $.ajax({
          url: "/cart/update_cart/" + productId + "/",
          method: "POST",
          data: { quantity: newQuantity },
          success: function(response) {
            //console.log(response)
            quantityElement.text(newQuantity);
          
            updatePriceAndTotal(response);
          },
          error: function(xhr, status, error) {
            //console.log(xhr.responseText);
          }
        });
      });
  
      // Function to update price and total based on the response
      function updatePriceAndTotal(response) {
        console.log("response in update ")
        console.log(response)
        if (response.success) {
          var subTotalElements = $(".sub_total_price");
          //console.log('subtotal :')
          //console.log(subTotalElements)
          var totalElement = $(".cart_total_amount span");
          var GSTElement = $(".cart_total_amount").eq(1);
          var grandTotalElement = $(".cart_total_amount").eq(2);
      
          // Update subtotals for each product
          subTotalElements.each(function(index) {
            var quantityElement = $(this).closest("tr").find(".qty-val").text();
            //console.log("quantityElement")
            //console.log(quantityElement)

            //var price =parseFloat($(this).closest("tr").find(".price span").text().replace("₹", ""))
            var price = parseFloat($(this).closest("tr").find(".product-price").text().replace("₹", ""));

            console.log("price")
            console.log(price)
            var quantity = parseInt(quantityElement);
            //console.log("quantity")
            //console.log(quantity)

            var newSubTotal = price * quantity;
            //console.log(newSubTotal)
            $(this).text("₹ " + newSubTotal.toFixed(2));
          });
          
          ///var newTotalAmount = response.new_total_amount;
          // Calculate total based on updated subtotals
          var newTotal = 0;
          subTotalElements.each(function(index) {
            var subtotal = parseFloat($(this).text().replace("₹ ", ""));
            newTotal += subtotal;
          });
          console.log('newTotal:')
          console.log(newTotal)
      
          // Calculate GST and grand total based on updated total
          var newGST = (5 * newTotal) / 100;
          console.log('newGST')
          console.log(newGST)
          var newGrandTotal = newTotal + newGST;
          console.log('newGrandTotal')
          console.log(newGrandTotal)
          //var newGST = (5 * newTotalAmount) / 100;
          //var newGrandTotal = newTotalAmount + newGST;
          totalElement.text("₹ " + newTotal.toFixed(2));
          console.log('totalElement')
          console.log(totalElement)
          GSTElement.text("₹ " + newGST.toFixed(2));
          console.log('GSTElement')
          console.log(GSTElement)
          grandTotalElement.text("₹ " + newGrandTotal.toFixed(2));
          console.log('grandTotalElement')
          console.log(grandTotalElement)
          ///totalElement.text("₹ " + newTotalAmount.toFixed(2));
          ///GSTElement.text("₹ " + newGST.toFixed(2));
          ///grandTotalElement.text("₹ " + newGrandTotal.toFixed(2));
         
        }
      }
      
  
      // Function to retrieve the CSRF token from cookies
      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
    });
</script> 
  {% comment %} <script>
    
    var url = $('#proceed-chekout').attr('href')
    console.log(url)
    $(document).on('submit', '#coupon-form', function(e){
        e.preventDefault()
        
       var che_url = url 
       console.log('che_url:')
       console.log(che_url)
        $('#resp').removeClass()
        $('#coupon-row').css({'display':'none',})
        var tot_amt = $('#total_amnt').text()
        var formData = new FormData(this)
        $.ajax({
            method:'POST',
            url:'/offer/coupon_verify/',
            data:formData,
            processData:false,
            contentType:false,
            success:function(response){
                   
                if (response.message == 'Coupon has been Applied'){
                    $('#resp').text(response.message).addClass('text-success')
                    $('#coupon-row').css({
                        'display':'table-row',
                    })
                    $('#discount-amount').text('₹' + response.coupon_discount)
                    //$('#total_amnt').text('₹' + response.final_amount)
                     // Calculate the new total amount including GST
                    var newTotalAmountWithGST = response.new_total_amount + response.gst_amount;
                    $('#total_amnt').text('₹' + newTotalAmountWithGST.toFixed(2));


                    $('#proceed-chekout').attr('href', che_url+response.coupon_id+'/')
                } else if(response.message.includes('Please')) {
                    
                    $('#resp').text(response.message).addClass('text-warning')
                    $('#total_amnt').text(tot_amt)
                    $('#proceed-chekout').attr('href', che_url)
                } else {
                    $('#resp').text(response.message).addClass('text-danger')
                    $('#total_amnt').text(tot_amt)
                    $('#proceed-chekout').attr('href', che_url)
                }
                
            }   
        })
    })
  </script>   {% endcomment %}
  <script>
    var url = $('#proceed-chekout').attr('href');
    console.log(url);
    
    $(document).on('submit', '#coupon-form', function(e) {
        e.preventDefault();

        var che_url = url;
        console.log('che_url:');
        console.log(che_url);

        $('#resp').removeClass();
        $('#coupon-row').css({ 'display': 'none' });
        var tot_amt = $('#total_amnt').text();
        var formData = new FormData(this);
        
        $.ajax({
            method: 'POST',
            url: '/offer/coupon_verify/',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.message == 'Coupon has been Applied') {
                    $('#resp').text(response.message).addClass('text-success');
                    $('#coupon-row').css({
                        'display': 'table-row',
                    });

                    // Update coupon discount amount and total amount
                    $('#discount-amount').text('₹' + response.coupon_discount.toFixed(2));
                    var newTotalAmountWithGST = response.final_amount;
                    $('#total_amnt').text('₹' + newTotalAmountWithGST.toFixed(2));

                    // Update the checkout link to include coupon ID
                    $('#proceed-chekout').attr('href', che_url + '?coupon_id=' + response.coupon_id);
                } else if (response.message.includes('Please')) {
                    $('#resp').text(response.message).addClass('text-warning');
                    $('#total_amnt').text(tot_amt);
                    $('#proceed-chekout').attr('href', che_url);
                } else {
                    $('#resp').text(response.message).addClass('text-danger');
                    $('#total_amnt').text(tot_amt);
                    $('#proceed-chekout').attr('href', che_url);
                }
            }
        });
    });
</script>


{% endblock script %}

  

  


